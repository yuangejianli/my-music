<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
  <script src="https://cdn.jsdelivr.net/npm/colorthief@2.3.2/dist/color-thief.umd.js"></script>

  <style>
    body { margin: 0; background: transparent; }

    .aplayer{
      border-radius: 0 !important;
      box-shadow: none !important;
      border: 1px solid #eee !important;
    }

    .aplayer .aplayer-list ol li .aplayer-list-cur { width: 2px !important; }
    .aplayer .aplayer-list ol li.aplayer-list-light { background: #e9e9e9 !important; }

    /* ✅ 关键：强制把“裁切窗口”锁到 .aplayer-list 这一层（用 !important 抢优先级） */
    .aplayer .aplayer-list{
      max-height: 120px !important;     /* 你想显示3首歌就 110~130 左右 */
      overflow: hidden !important;      /* 伪滚动必须隐藏真实滚动 */
      position: relative !important;
      height: auto !important;          /* 防止 APlayer 内联高度干扰 */
    }

    /* ✅ 让 ol 做位移（伪滚动本体） */
    .aplayer .aplayer-list ol{
      transition: transform 0.35s ease !important;
      will-change: transform;
      margin: 0 !important;
    }
  </style>
</head>

<body>
  <div id="aplayer"></div>

  <script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

  <script>
    const audioList = [
      { name: 'Her Silence', artist: '何真真', url: 'music/何真真 - Her Silence.mp3', cover: 'cover/何真真 - Her Silence.jpg' },
      { name: 'Hurricanes', artist: 'Dido', url: 'music/Dido - Hurricanes.mp3', cover: 'cover/Dido - Hurricanes.jpg' },
      { name: 'Everytime you kissed me', artist: 'FictionJunction', url: 'music/FictionJunction - Everytime you kissed me.mp3', cover: 'cover/FictionJunction - Everytime you kissed me.jpg' },
      { name: '沙尘的彼方', artist: 'FictionJunction', url: 'music/FictionJunction - 沙尘的彼方.mp3', cover: 'cover/FictionJunction - 沙尘的彼方.jpg' },
      { name: 'My long forgotten cloistered sleep', artist: 'FictionJunction', url: 'music/FictionJunction - My long forgotten cloistered sleep.mp3', cover: 'cover/FictionJunction - My long forgotten cloistered sleep.jpg' },
      { name: '花守之丘', artist: 'FictionJunction', url: 'music/FictionJunction - 花守之丘.mp3', cover: 'cover/FictionJunction - 花守之丘.jpg' },
      { name: 'Rewrite The Stars', artist: 'Zendaya', url: 'music/Zendaya - Rewrite The Stars.mp3', cover: 'cover/Zendaya - Rewrite The Stars.jpg' }
    ];

    const ap = new APlayer({
      container: document.getElementById('aplayer'),
      listFolded: false,
      audio: audioList,
      theme: '#e9e9e9'
    });

    /* =========================
       ✅ 伪滚动：用 active.offsetTop 计算真实位置（更稳）
       ========================= */
    function fakeScrollToActive() {
      const wrap = document.querySelector('.aplayer .aplayer-list');
      const ol = document.querySelector('.aplayer .aplayer-list ol');
      const active = document.querySelector('.aplayer .aplayer-list li.aplayer-list-light');
      if (!wrap || !ol || !active) return;

      // 如果内容本来就没超出窗口，就归零
      if (ol.scrollHeight <= wrap.clientHeight + 2) {
        ol.style.transform = 'translateY(0px)';
        return;
      }

      // 目标：让 active 出现在窗口的 35% 处（偏上，不会卡底）
      const desiredTop = wrap.clientHeight * 0.35;

      // active 在 ol 里的真实 top
      const activeTop = active.offsetTop;

      // 计算位移：把 activeTop 拉到 desiredTop
      let offset = activeTop - desiredTop;

      // 限制上下边界，避免拉过头
      const maxOffset = Math.max(0, ol.scrollHeight - wrap.clientHeight);
      if (offset < 0) offset = 0;
      if (offset > maxOffset) offset = maxOffset;

      ol.style.transform = `translateY(${-offset}px)`;
    }

    // ✅ 多次延迟执行：确保 Notion + APlayer 的高亮类名已经更新
    function ensureFakeScroll() {
      requestAnimationFrame(fakeScrollToActive);
      setTimeout(fakeScrollToActive, 60);
      setTimeout(fakeScrollToActive, 150);
      setTimeout(fakeScrollToActive, 300);
    }

    /* =========================
       变色龙（稳定版）
       ========================= */
    const colorThief = new ColorThief();
    const DEFAULT_THEME = '#e9e9e9';
    let themeTimer = null;

    function updateThemeSafe(retry = 0) {
      const index = ap.list.index;
      const imgUrl = audioList[index]?.cover;
      if (!imgUrl) return;

      clearTimeout(themeTimer);
      themeTimer = setTimeout(() => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.referrerPolicy = 'no-referrer';

        img.onload = () => {
          try {
            const c = colorThief.getColor(img);
            ap.theme(`rgb(${c[0]}, ${c[1]}, ${c[2]})`, index);
          } catch (e) {
            retry < 3 ? setTimeout(() => updateThemeSafe(retry + 1), 250)
                      : ap.theme(DEFAULT_THEME, index);
          }
        };

        img.onerror = () => {
          retry < 3 ? setTimeout(() => updateThemeSafe(retry + 1), 250)
                    : ap.theme(DEFAULT_THEME, index);
        };

        img.src = imgUrl + (imgUrl.includes('?') ? '&' : '?') + 'cb=' + Date.now();
      }, 60);
    }

    /* =========================
       事件绑定
       ========================= */
    ap.on('listswitch', () => {
      ensureFakeScroll();
      updateThemeSafe(0);
    });

    // 点击列表项时也触发（更符合你的“手点第3首/第4首”场景）
    document.addEventListener('click', (e) => {
      const inList = e.target && e.target.closest && e.target.closest('.aplayer .aplayer-list');
      if (inList) ensureFakeScroll();
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        ensureFakeScroll();
        updateThemeSafe(0);
      }, 400);
    });
  </script>
</body>
</html>
